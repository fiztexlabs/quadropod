<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes">

    <title>Stairway module</title>
	
	<style>
		button {
			display:block;
		}
		submitbutton {
			display:block;
		}
		span {
			display:block;
		}
	</style>
	
  </head>
  <body>
	<span class="badge badge-default" id="Status">LED status: full auto</span> 
	<button type="button" class="btn btn-success" id="LedOnButton">
		LED On
	</button> 
	<button type="button" class="btn btn-danger" id="LedOffButton">
		LED Off
	</button> 
	<button type="button" class="btn btn-outline-success" id="SetFullAutoButton">
		Set full automatic mode
	</button>
	<span id="Power">LED power: 100%</span> 
	<form action="" method="post">
		<label for="PowerValue">Power:</label>
		<input type="text" name="name" size="10" id="PowerValue"> 
		<button type="submitbutton" class="btn btn-outline-success" id="SetPower">
			Set power
		</button>
	</form>
	<div>
		<input type="color" id="Color" name="Color"
			value="#808080">
		<button for="Color" class="btn btn-outline-success" id="SetColor">
			Set color
		</button>
	</div> 
	<span id="CurrDaylight">Current daylight: </span> 
	<span id="Daylight">LED threshold daylight: 50</span> 
	<form action="" method="post">
		<label for="LightValue">Threshold daylight:</label>
		<input type="text" name="name" size="10" id="LightValue"> 
		<button type="submitbutton" class="btn btn-outline-success" id="SetDaylight">
			Set daylight
		</button>
	</form>
</div>
	<script>
		var led_on = document.getElementById("LedOnButton");
		var led_off = document.getElementById("LedOffButton");
		var led_auto = document.getElementById("SetFullAutoButton");
		var maxpower = document.getElementById("PowerValue");
		var setpower = document.getElementById("SetPower");
		var daylight = document.getElementById("LightValue");
		var setdaylight = document.getElementById("SetDaylight");
		var setcolor = document.getElementById("SetColor");
		var color = document.getElementById("Color");
		function led_state()
		{
			var request = new XMLHttpRequest();
			request.open('GET','/led_status',true);
			request.send();
			request.onload = function() {
				if (request.readyState == 4 && request.status == 200) {
					var response = request.responseText;
					led_status = Number.parseInt(response);
					if (led_status == 254)
						document.getElementById("Status").textContent="LED status: user mode, led Off";
					if (led_status == 255)
						document.getElementById("Status").textContent="LED status: user mode, led On";
					if (led_status == 0)
						document.getElementById("Status").textContent="LED status: full auto";
					if (led_status == 2)
						document.getElementById("Status").textContent="LED status: user color auto";
				}
			}
		}
		function led_power()
		{
			var request = new XMLHttpRequest();
			request.open('GET','/led_power',true);
			request.send();
			request.onload = function() {
				if (request.readyState == 4 && request.status == 200) {
					var response = request.responseText;
					document.getElementById("Power").textContent="LED power: "+response+"%";
				}
			}
		}
		function led_daylight_threshold()
		{
			var request = new XMLHttpRequest();
			request.open('GET','/led_daylight',true);
			request.send();
			request.onload = function() {
				if (request.readyState == 4 && request.status == 200) {
					var response = request.responseText;
					document.getElementById("Daylight").textContent="LED threshold daylight: "+response;
				}
			}
		}
		function led_curr_daylight()
		{
			var request = new XMLHttpRequest();
			request.open('GET','/get_light_level',true);
			request.send();
			request.onload = function() {
				if (request.readyState == 4 && request.status == 200) {
					var response = request.responseText;
					document.getElementById("CurrDaylight").textContent="Current daylight: "+response;
				}
			}
		}
		function led_color()
		{
			var request = new XMLHttpRequest();
			request.open('GET','/led_color',true);
			request.send();
			request.onload = function() {
				if (request.readyState == 4 && request.status == 200) {
					var response = request.responseText;
					color.value=response;
				}
			}
		}
		function led_On()
		{
			var request = new XMLHttpRequest();
			request.open('GET','/led_on',false);
			request.send();
			led_state();
			led_color();
		}
		function led_Off()
		{
			var request = new XMLHttpRequest();
			request.open('GET','/led_off',false);
			request.send();
			led_state();
		}
		function led_Auto()
		{
			var request = new XMLHttpRequest();
			request.open('GET','/led_auto',false);
			request.send();
			led_state();
			led_color();
		}
		function set_power()
		{
			var request = new XMLHttpRequest();
			request.open('POST',"/set_power?MaxPower="+maxpower.value,false);
			request.send();
			led_power();
		}
		function set_daylight()
		{
			var request = new XMLHttpRequest();
			request.open('POST',"/set_light_level?LightLevel="+daylight.value,false);
			request.send();
			led_daylight_threshold();
		}
		function set_rgb()
		{
			var R = parse_hex(1, color.value);
			var G = parse_hex(2, color.value);
			var B = parse_hex(3, color.value);
			
			var request = new XMLHttpRequest();
			var msg = "/set_color?R="+String(R)+"&G="+String(G)+"&B="+String(B);
			console.log(msg);
			request.open('POST',msg,false);
			request.send();
			led_state();
		}
		function parse_hex(id, hex) 
		{
			if (!/^#?([a-f\d]{3,4}|[a-f\d]{6}|[a-f\d]{8})$/i.test(hex)) return null;
			hex = hex.replace(/#/, "");
			
			/***/
			if (hex.length < 6) { // abc â†’ aabbcc
				hex = hex.replace(/(.)/g, "$1$1");
			}
			var dec = hex.match(/../g).map(function(val) { return parseInt(val, 16) });
			
			/***/
			var type = "rgb";
			if (dec.length > 3) {
				type = "rgba";
				dec[3] = Math.round(100 * 255 / dec[3]) / 100;
			}
			if(id == 0)
				return type;
			if(id == 1)
				return dec[0];
			if(id == 2)
				return dec[1];
			if(id == 3)
				return dec[2];
		}
		setInterval(function()
		{
			led_state();
			led_curr_daylight();
		}, 5000);
		
		document.addEventListener('DOMContentLoaded', led_state);
		document.addEventListener('DOMContentLoaded', led_power);
		document.addEventListener('DOMContentLoaded', led_daylight_threshold);
		document.addEventListener('DOMContentLoaded', led_curr_daylight);
		document.addEventListener('DOMContentLoaded', led_color);
		led_on.addEventListener('click', led_On);
		led_off.addEventListener('click', led_Off);
		led_auto.addEventListener('click', led_Auto);
		setdaylight.addEventListener('click', set_daylight);
		setpower.addEventListener('click', set_power);
		setcolor.addEventListener('click', set_rgb);
	</script>
  </body>
</html>